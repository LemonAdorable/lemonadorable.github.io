---
interface Props {
  class?: string
}

const { class: className } = Astro.props
---

<div id="giscus" class={className}></div>

<script>
  // Giscus配置
  const giscusConfig = {
    repo: 'LemonAdorable/lemonadorable.github.io',
    repoId: 'R_kgDOLJXF6A',
    category: 'Announcements',
    categoryId: 'DIC_kwDOLJXF6M4Ccs4x',
    mapping: 'pathname',
    strict: '0',
    reactionsEnabled: '1',
    emitMetadata: '1',
    inputPosition: 'top',
    lang: 'zh-CN',
    loading: 'lazy',
    crossorigin: 'anonymous'
  }

  // 获取当前主题
  function getTheme() {
    const isDark = document.body.classList.contains('dark') || 
                   localStorage.getItem('pref-theme') === 'dark' ||
                   (!localStorage.getItem('pref-theme') && window.matchMedia('(prefers-color-scheme: dark)').matches)
    return isDark ? 'dark_tritanopia' : 'light_protanopia'
  }

  // 更新Giscus主题
  function updateGiscusTheme(theme: string) {
    const iframe = document.querySelector('iframe.giscus-frame') as HTMLIFrameElement | null
    if (iframe && iframe.contentWindow) {
      iframe.contentWindow.postMessage(
        { giscus: { setConfig: { theme } } },
        'https://giscus.app'
      )
    }
  }

  // 初始化Giscus
  function initGiscus() {
    const script = document.createElement('script')
    script.src = 'https://giscus.app/client.js'
    script.setAttribute('data-repo', giscusConfig.repo)
    script.setAttribute('data-repo-id', giscusConfig.repoId)
    script.setAttribute('data-category', giscusConfig.category)
    script.setAttribute('data-category-id', giscusConfig.categoryId)
    script.setAttribute('data-mapping', giscusConfig.mapping)
    script.setAttribute('data-strict', giscusConfig.strict)
    script.setAttribute('data-reactions-enabled', giscusConfig.reactionsEnabled)
    script.setAttribute('data-emit-metadata', giscusConfig.emitMetadata)
    script.setAttribute('data-input-position', giscusConfig.inputPosition)
    script.setAttribute('data-theme', getTheme())
    script.setAttribute('data-lang', giscusConfig.lang)
    script.setAttribute('data-loading', giscusConfig.loading)
    script.setAttribute('crossorigin', giscusConfig.crossorigin)
    script.async = true

    const container = document.getElementById('giscus')
    if (container) {
      container.appendChild(script)
    }
  }

  // 监听主题切换
  function setupThemeListener() {
    // 监听主题切换按钮
    const themeToggle = document.getElementById('toggleDarkMode')
    if (themeToggle) {
      themeToggle.addEventListener('click', () => {
        setTimeout(() => {
          updateGiscusTheme(getTheme())
        }, 100)
      })
    }

    // 监听系统主题变化
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
      if (!localStorage.getItem('pref-theme')) {
        updateGiscusTheme(getTheme())
      }
    })
  }

  // 页面加载完成后初始化
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      initGiscus()
      setupThemeListener()
    })
  } else {
    initGiscus()
    setupThemeListener()
  }
</script>

<style>
  #giscus {
    margin-top: 2rem;
  }
</style>

