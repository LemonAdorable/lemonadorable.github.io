---
import { socialLinks, type iconsType } from 'astro-pure/types'
import { Icon } from 'astro-pure/user'

interface SubstatsItem {
  platform: string
  icon?: (typeof socialLinks)[number]
  iconUrl?: string
  color?: string
  link?: string
  text: string
  api?: string
  count?: number
}

type Props = {
  stats: SubstatsItem[]
}

const { stats } = Astro.props as Props

async function fetchCount(item: SubstatsItem) {
  if (!item.api) return
  try {
    const response = await fetch(`https://api.swo.moe/stats/${item.api}`)

    // 检查响应状态
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`)
    }

    // 检查 Content-Type 是否为 JSON
    const contentType = response.headers.get('content-type')
    if (!contentType || !contentType.includes('application/json')) {
      // 如果不是 JSON，尝试读取文本以查看实际返回的内容
      const text = await response.text()
      throw new Error(`Expected JSON but got ${contentType}. Response: ${text.substring(0, 100)}`)
    }

    const data = await response.json()
    if (data.failed) {
      throw new Error(data.message)
    } else {
      item.count = data.count
    }
  } catch (error) {
    console.error(`Error in Substats fetching for ${item.platform}: ${error}`)
  }
}

await Promise.all(stats.map(fetchCount))
---

<div class='flex flex-wrap gap-2.5'>
  {
    stats.map(({ link, platform, icon, iconUrl, color, count }) => {
      const content = (
        <div class='flex items-center gap-2 rounded-xl border bg-background/50 px-3 py-1.5 transition-all hover:bg-muted shadow-sm'>
          {icon && <Icon name={icon as iconsType} color={color} class='size-4' />}
          {iconUrl && <img src={iconUrl} alt={platform} class='size-4 object-contain' />}
          <span class='text-sm font-medium text-foreground transition-colors group-hover:text-primary'>
            {platform}
          </span>
          {count && (
            <span class='text-xs text-muted-foreground bg-muted px-1.5 py-0.5 rounded-md ml-1 font-mono'>
              {count}
            </span>
          )}
        </div>
      )

      return link ? (
        <a
          class='group text-muted-foreground no-underline'
          href={link}
          target='_blank'
          rel='noopener noreferrer'
        >
          {content}
        </a>
      ) : (
        <div class='group text-muted-foreground'>{content}</div>
      )
    })
  }
</div>
<div class='mt-2 text-right text-sm'>
  Display real-time; powered by <a
    class='text-muted-foreground'
    href='http://github.com/spencerwooo/substats'
    target='_blank'
    rel='noopener noreferrer'>Substats</a
  >
</div>
